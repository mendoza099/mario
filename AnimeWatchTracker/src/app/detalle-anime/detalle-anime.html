@if (cargando()) {
  <div class="loading-container">
    <p>Cargando anime...</p>
  </div>
}

@if (error() && !cargando()) {
  <div class="error-container">
    <p>{{ error() }}</p>
    <a routerLink="/" class="back-button">Volver al inicio</a>
  </div>
}

@if (anime() && !cargando()) {
  <div class="detalle-container">
    <div class="anime-header">
      <div class="anime-poster">
        <img [src]="anime()!.images.jpg.large_image_url" [alt]="anime()!.title" />
      </div>
      
      <div class="anime-main-info">
        <h1>{{ anime()!.title }}</h1>
        
        @if (anime()!.title_english) {
          <h2 class="title-english">{{ anime()!.title_english }}</h2>
        }
        
        <div class="info-badges">
          <span class="badge type">{{ anime()!.type }}</span>
          <span class="badge status" [class.airing]="anime()!.airing">
            {{ anime()!.status }}
          </span>
          <span class="badge score">‚≠ê {{ anime()!.score || 'N/A' }}</span>
          @if (anime()!.episodes) {
            <span class="badge episodes">{{ anime()!.episodes }} episodios</span>
          }
        </div>

        <div class="genres">
          @for (genre of anime()!.genres; track genre.mal_id) {
            <span class="genre-tag">{{ genre.name }}</span>
          }
        </div>

        <div class="synopsis">
          <h3>Sinopsis</h3>
          <p>{{ anime()!.synopsis || 'No hay sinopsis disponible' }}</p>
        </div>

        <div class="list-actions">
          @if (!estaEnLista()) {
            <div class="add-to-list">
              <select (change)="alCambiarEstado($event)" [value]="estadoSeleccionado()">
                <option value="Pendiente">Pendiente</option>
                <option value="Viendo">Viendo</option>
                <option value="Completado">Completado</option>
                <option value="Abandonado">Abandonado</option>
              </select>
              <button (click)="agregarALista()" class="btn-primary">A√±adir a Mi Lista</button>
            </div>
          } @else {
            <div class="manage-list">
              <select (change)="alCambiarEstado($event)" [value]="estadoSeleccionado()">
                <option value="Pendiente">Pendiente</option>
                <option value="Viendo">Viendo</option>
                <option value="Completado">Completado</option>
                <option value="Abandonado">Abandonado</option>
              </select>
              
              <button (click)="cambiarFavorito()" 
                      [class.favorite]="esFavorito()"
                      class="btn-favorite">
                {{ esFavorito() ? '‚ù§Ô∏è Favorito' : 'ü§ç Marcar favorito' }}
              </button>
              
              <button (click)="eliminarDeLista()" class="btn-danger">Eliminar de lista</button>
            </div>
          }
        </div>
      </div>
    </div>

    <div class="anime-details">
      <div class="episodes-section">
        <h3>Episodios</h3>
        
        @if (cargandoEpisodios()) {
          <p class="loading-text">Cargando episodios...</p>
        }
        
        @if (episodios().length > 0 && !cargandoEpisodios()) {
          <div class="episodes-list">
            @for (episodio of episodios(); track episodio.mal_id) {
              <div class="episode-item">
                <span class="episode-number">Ep. {{ episodio.mal_id }}</span>
                <div class="episode-info">
                  <h4>{{ episodio.title }}</h4>
                  @if (episodio.aired) {
                    <span class="episode-date">{{ episodio.aired }}</span>
                  }
                </div>
              </div>
            }
          </div>
        }
        
        @if (episodios().length === 0 && !cargandoEpisodios()) {
          <p class="no-data">No hay episodios disponibles</p>
        }
      </div>

      <div class="reviews-section">
        <h3>Rese√±as</h3>
        
        @if (cargandoResenas()) {
          <p class="loading-text">Cargando rese√±as...</p>
        }
        
        @if (resenas().length > 0 && !cargandoResenas()) {
          <div class="reviews-list">
            @for (resena of resenas(); track resena.mal_id) {
              <div class="review-item">
                <div class="review-header">
                  <div class="review-user">
                    <img [src]="resena.user.images.jpg.image_url" [alt]="resena.user.username" />
                    <span>{{ resena.user.username }}</span>
                  </div>
                  <span class="review-score">‚≠ê {{ resena.score }}/10</span>
                </div>
                <p class="review-text">{{ recortarTexto(resena.review, 300) }}</p>
                <a [href]="resena.url" target="_blank" class="review-link">Leer m√°s</a>
              </div>
            }
          </div>
        }
        
        @if (resenas().length === 0 && !cargandoResenas()) {
          <p class="no-data">No hay rese√±as disponibles</p>
        }
      </div>
    </div>

    <div class="back-link">
      <a routerLink="/">‚Üê Volver al buscador</a>
    </div>
  </div>
}
